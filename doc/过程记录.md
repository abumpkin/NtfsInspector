# 过程记录

## 1 列出所有分区

利用以下三个 API, 我们可以把系统里所有磁盘的分卷列出来:

* [FindFirstVolume](https://learn.microsoft.com/zh-cn/windows/win32/api/winbase/nf-winbase-findfirstvolumea)
* FindNextVolume
* FindVolumeClose

效果如下:

![列出所有分区](./.img/Screenshot%202023-04-06%20192802.png)

## 2 访问分区

使用以下 API 可以访问任意 I/O 设备, 也包括分区:

* [CreateFile](https://learn.microsoft.com/zh-cn/windows/win32/api/fileapi/nf-fileapi-createfilea)
* SetFilePointer
* [GetFileSize](https://learn.microsoft.com/zh-cn/windows/win32/api/fileapi/nf-fileapi-getfilesize) (不可用)
* SetFilePointer (需为扇区的整数倍)
* [ReadFile](https://learn.microsoft.com/zh-cn/windows/win32/api/fileapi/nf-fileapi-readfile)
* [WriteFile](https://learn.microsoft.com/zh-cn/windows/win32/api/fileapi/nf-fileapi-writefile)

### 写操作

要向卷写入, 需先获取对卷的独占访问权限:

* 使用 [FSCTL_LOCK_VOLUME](https://learn.microsoft.com/zh-cn/windows/desktop/api/winioctl/ni-winioctl-fsctl_lock_volume) 锁定卷.
* 或使用 [FSCTL_DISMOUNT_VOLUME](https://learn.microsoft.com/zh-cn/windows/desktop/api/winioctl/ni-winioctl-fsctl_dismount_volume) 卸载卷.

向 1000 扇区写入字符 "0" 的效果:

![xir](./.img/Screenshot%202023-04-06%20214616.png)