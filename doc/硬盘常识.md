<div align="right">2023-04-07</div>

---

# 硬盘常识

硬盘通过 **分区结构** 进行分区, 在 NTFS 中把分区称为 **卷(volume)**.

常用的 **分区结构** 如下:

* MBR 硬盘分区
* 动态硬盘分区
* GPT 硬盘分区

**分区** 内的部分称为 **逻辑硬盘**, 一个 **逻辑硬盘** 对应一个 **文件系统**.

所以 **文件系统** 是在 **分区** 里起作用的.

## NTFS

基本思想: 在 NTFS 里一切皆 **文件**.

* **主文件表(Master File Table, MFT)** 负责对 **文件** 的索引.
* **MFT** 列出了 **引导扇区文件($Boot)**, 位于硬盘的开头处.
* **引导扇区文件($Boot)** 也列出了到哪里找到 **MFT**.
* **VCN(virtual cluster number)** 虚拟簇号, **LCN 逻辑簇号**.
* **MFT** 是一系列 **FILE 记录(FILE records)**, 每个文件被一个或多个 **FILE 记录** 表示.
* **FILE 记录** 等价于 Unix 里的 **Inode**.
* 文件的第一个 **FILE 记录** 叫做 **Base FILE 记录**, 其他的叫做 **Extension FILE 记录**.
* 一个 **FILE 记录** 由 (**头部**, 几个可变长度**属性**, **结尾标志(0xFFFFFFFF)**) 组成.
* **常驻** 与 **非常驻**:
  * 当一个文件很小时, 其所有属性和属性值可以存放在 MFT 的文件记录中, 当属性值能直接放在 MFT 中时, 该属性就称为 **常驻属性(resident attribute)**.
  * 有些属性总是 **常驻属性**.
* 每个 **属性** 都以一个 **标准头** 开始.

总体结构:

* Boot(1 扇区)
* MFT
* 自由空间
* 更多的元数据
* 自由空间

`$Boot` 文件结构:

![$Boot](./.img/Screenshot%202023-04-07%20071122.png)

**FILE 记录** 结构:

![FILE 记录](./.img/Screenshot%202023-04-07%20092420.png)

### data runs

![data runs](./.img/Screenshot%202023-04-07%20184257.png)

* **长度** 和 **簇号偏移** 的大小分别存在第一个字节的低半字节 和 高半字节.
* **簇号偏移** 是有符号数.
* 对于压缩或稀疏流(sparse runs), **簇号偏移** 是 0, **簇号偏移** 的大小也是 0.
* 每个 **压缩单元(compression unit)** 以 16 的倍数簇号开始.
* 如果 **压缩单元** 可用, 单元里可能出现一个或多个 **空流**.
* 如果有 **数据流** 里超过 16 个簇, 则此流的 **单元** 不可压缩.

### 更新序列(US), 更新序列号(USN) 和 更新数组

* 在日志记录中的 **USN** (长 8 字节):
  * **USN** 是 `$UsnJrnl` 文件中 `$J` 数据属性数据中记录的偏移值.
  * **USN** 信息也会记录在 **MFT 记录**(即 **文件记录**) 的 `$STANDARD_INFORMATION` 属性中.
* 在文件记录头中的 **US** (长 2 字节):
  * **US** 的值与 **文件记录** 每个扇区最后两个字节相同.
  * 用来作为校验值, 当载入内存时, 检查 **US** 是否和每个扇区最后两个字节相同, 相同则说明 **文件记录** 没有问题.
  * 每次修改 **文件记录** 时 **US** 加 1, 循环计数, 当为 0 时再加一个 1.
* **更新数组**:
  * **更新数组** 包含每个扇区最后两个字节的真实值.
